# backend/app/services/vulnerability_service.py

from app.vuln_sources.nvd_client import NVDClient
from app.vuln_sources.osv_client import OSVClient
from app.config import NVD_API_KEY, CVSS_LEVELS


class VulnerabilityService:
    """
    Handles vulnerability lookups using NVD and OSV
    """

    def __init__(self):
        self.nvd = NVDClient(api_key=NVD_API_KEY)
        self.osv = OSVClient()

    def check_web_technology(self, name: str, version: str | None = None):
        """
        For Apache, Nginx, WordPress, PHP, etc.
        """
        cves = self.nvd.search(name, version)
        return self._attach_severity(cves)

    def check_library(self, ecosystem: str, package: str, version: str):
        """
        For React, Express, Node.js, npm, pip packages
        """
        return self.osv.query(ecosystem, package, version)

    def _attach_severity(self, cves: list) -> list:
        for cve in cves:
            cve["severity"] = self._cvss_to_severity(cve.get("cvss"))
        return cves

    def _cvss_to_severity(self, score):
        if score is None:
            return "UNKNOWN"

        for level, (low, high) in CVSS_LEVELS.items():
            if low <= score <= high:
                return level
        return "UNKNOWN"
